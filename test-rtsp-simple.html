<!DOCTYPE html>
<html>
<head>
    <title>Simple RTSP Test</title>
</head>
<body>
    <h1>Simple RTSP Stream Test</h1>
    <button onclick="testRTSPStream()">Test RTSP Stream</button>
    <div id="status"></div>
    <canvas id="video-canvas" width="640" height="480" style="border: 1px solid black; margin-top: 10px;"></canvas>

    <script src="/jsmpeg.min.js"></script>
    <script>
        function log(message) {
            document.getElementById('status').innerHTML += message + '<br>';
            console.log(message);
        }

        function testRTSPStream() {
            log('üé¨ Testing RTSP stream...');
            
            const cameraId = '690cc79e0038023fd83c'; // Your camera ID
            const rtspUrl = 'rtsp://10.254.12.134:9000/live';
            
            const ws = new WebSocket(`ws://localhost:9999/rtsp-stream?camera=${cameraId}&rtsp=${encodeURIComponent(rtspUrl)}`);
            
            ws.onopen = () => {
                log('‚úÖ Control WebSocket connected');
            };
            
            ws.onmessage = (event) => {
                log('üì® Message: ' + event.data);
                
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'stream_ready') {
                        log('üìπ Stream ready on port: ' + data.wsPort);
                        startPlayer(data.wsPort);
                    } else if (data.type === 'error') {
                        log('‚ùå Server error: ' + data.message);
                    }
                } catch (e) {
                    log('‚ùå Message parse error: ' + e);
                }
            };
            
            ws.onerror = (error) => {
                log('‚ùå Control WebSocket error: ' + error);
            };

            ws.onclose = (event) => {
                log('üîå Control WebSocket closed: ' + event.code + ' - ' + event.reason);
            };
        }

        function startPlayer(port) {
            if (!window.JSMpeg) {
                log('‚ùå JSMpeg not loaded');
                return;
            }

            log('üé¨ Starting JSMpeg player on port: ' + port);
            
            const canvas = document.getElementById('video-canvas');
            
            try {
                const player = new JSMpeg.Player(`ws://localhost:${port}`, {
                    canvas: canvas,
                    autoplay: true,
                    audio: false,
                    videoBufferSize: 1024 * 1024,
                    audioBufferSize: 128 * 1024,
                    onPlay: () => {
                        log('‚úÖ Video playback started!');
                    },
                    onStalled: () => {
                        log('‚ö†Ô∏è Video playback stalled');
                    },
                    onError: (error) => {
                        log('‚ùå JSMpeg player error: ' + error);
                    }
                });
                
                log('‚úÖ JSMpeg player created');
                
                // Test connection after a delay
                setTimeout(() => {
                    if (player.isPlaying) {
                        log('üé• Video is playing successfully!');
                    } else {
                        log('‚ö†Ô∏è Video not playing yet...');
                    }
                }, 3000);
                
            } catch (error) {
                log('‚ùå Failed to create JSMpeg player: ' + error);
            }
        }

        // Auto-load JSMpeg on page load
        window.onload = () => {
            if (window.JSMpeg) {
                log('‚úÖ JSMpeg library loaded');
            } else {
                log('‚ùå JSMpeg library not loaded');
            }
        };
    </script>
</body>
</html>
